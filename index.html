<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Demo App — SSO Jeivian</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root { --bg:#0b1020; --fg:#cde3ff; --muted:#6b7280; --ok:#22c55e; --err:#ef4444; --warn:#f59e0b; --card:#ffffff; --border:#e5e7eb; --brand:#1f6feb; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; color:#111827; background:#f8fafc; }
    a { color: inherit; text-decoration: none; }
    .container { max-width: 980px; margin: 24px auto; padding: 0 16px; }

    /* Header */
    header { background:#fff; border-bottom:1px solid var(--border); position: sticky; top:0; z-index: 20; }
    .nav { display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 12px 16px; }
    .brand { display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px; }
    .brand-badge { background:#eff6ff; color:#1d4ed8; padding:3px 8px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid #dbeafe; }
    .user { display:flex; align-items:center; gap:10px; position: relative; }
    .user-name { font-weight:700; font-size:14px; }
    .user-email { color:#6b7280; font-size:12px; }
    .avatar { width:32px; height:32px; border-radius:999px; background:#e5e7eb; display:grid; place-items:center; font-size:12px; font-weight:800; color:#374151; border:1px solid #d1d5db; overflow:hidden; }
    .menu { background:#fff; border:1px solid var(--border); border-radius:10px; position:absolute; right:0; top:44px; min-width: 220px; box-shadow: 0 10px 30px rgba(0,0,0,.08); display:none; }
    .menu.open { display:block; }
    .menu .item { padding:10px 12px; display:flex; gap:10px; align-items:center; cursor:pointer; }
    .menu .item:hover { background:#f3f4f6; }
    .pill { padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; font-size:12px; }

    main .card { background:#fff; border:1px solid var(--border); border-radius:10px; padding:16px; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 16px; }
    pre.log { white-space: pre-wrap; background: var(--bg); color: var(--fg); padding: 12px; border-radius: 8px; font-size: 12px; height: 220px; overflow: auto; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .muted { color:#6b7280; font-size:12px; }
    button { padding:8px 12px; border:1px solid #d1d5db; background:#fff; border-radius:8px; cursor:pointer; }
    button.primary { background:#1f6feb; color:#fff; border-color:#1f6feb; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.1" crossorigin="anonymous"></script>
  <script>
    // Config: mismo proyecto de Supabase que usa el Hub
    const CONFIG = {
      SUPABASE_URL: 'https://login.jeivian.com',
      SUPABASE_ANON: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0',
      HUB_URL: 'https://sso.jeivian.com/',
      BUILD: 'demo-2025-09-11'
    };
  </script>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">
        <span>Mini App</span>
        <span class="brand-badge">SSO</span>
      </div>
      <div class="user" id="userArea" style="visibility:hidden">
        <div class="user-info">
          <div class="user-name" id="userName">—</div>
          <div class="user-email" id="userEmail">—</div>
        </div>
        <div class="avatar" id="avatar"></div>
        <div class="menu" id="menu">
          <div class="item" id="btnCopyAT">Copiar access_token</div>
          <div class="item" id="btnCopyRT">Copiar refresh_token</div>
          <div class="item" id="btnLogout">Cerrar sesión</div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:700;">Estado</div>
            <div class="muted">Inicio de sesión automático usando Hub SSO</div>
          </div>
          <div>
            <span class="pill" id="status">Cargando…</span>
          </div>
        </div>
        <div style="margin-top:12px;" class="muted">BUILD: <span id="build"></span></div>
      </div>

      <div class="card">
        <div style="font-weight:700; margin-bottom:8px;">Logs</div>
        <pre class="log" id="log"></pre>
      </div>

      <div class="card">
        <div style="font-weight:700; margin-bottom:8px;">¿Qué hace esta demo?</div>
        <ul>
          <li>Si no hay sesión ni tokens en la URL, redirige al Hub SSO.</li>
          <li>Tras autenticación, el Hub vuelve a esta página con <code>#access_token</code> y <code>#refresh_token</code>.</li>
          <li>La app llama <code>supabase.auth.setSession</code> con esos tokens y pinta nombre/email/avatar.</li>
          <li>“Cerrar sesión” invalida la sesión local y vuelve a enviar al Hub para re-login.</li>
        </ul>
        <div class="muted">Nota: en producción, el Hub sólo redirige a <code>https://*.jeivian.com</code>. Usa un subdominio de ese dominio para pruebas.</div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const $ = (id) => document.getElementById(id);
    const logEl = $('log');
    const log = (m) => { const t = new Date().toISOString().slice(11,19); logEl.textContent += `[${t}] ${m}\n`; logEl.scrollTop = logEl.scrollHeight; };
    const ok  = (m) => log(`✅ ${m}`);
    const err = (m) => log(`❌ ${m}`);

    $('build').textContent = CONFIG.BUILD;

    const supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false }
    });

    // Evitar bucles: enfriar reintentos de login por unos segundos
    const COOLDOWN_MS = 7000;
    function shouldCooldown(){
      try { const last = Number(sessionStorage.getItem('demo-last-login') || 0); return Date.now() - last < COOLDOWN_MS; }
      catch(_) { return false; }
    }
    function markCooldown(){
      try { sessionStorage.setItem('demo-last-login', String(Date.now())); }
      catch(_) {}
    }

    function targetSelf(){
      // Sin hash; el Hub agregará #access_token y #refresh_token
      return `${location.origin}${location.pathname}${location.search}`;
    }

    function redirectToHub(){
      const url = `${CONFIG.HUB_URL}?target=${encodeURIComponent(targetSelf())}`;
      ok('Redirigiendo al Hub SSO…');
      markCooldown();
      window.location.replace(url);
    }

    function parseHashTokens(){
      const h = (location.hash || '').replace(/^#/, '');
      const p = new URLSearchParams(h);
      const access_token = p.get('access_token') || '';
      const refresh_token = p.get('refresh_token') || '';
      return { access_token, refresh_token };
    }

    function clearHash(){
      history.replaceState({}, document.title, `${location.pathname}${location.search}`);
    }

    function getUserDisplay(user){
      const meta = user?.user_metadata || {};
      const full = meta.name || meta.full_name || meta.preferred_username || '';
      const email = user?.email || '';
      const name = full || (email ? email.split('@')[0] : 'Usuario');
      const picture = meta.avatar_url || meta.picture || '';
      return { name, email, picture };
    }

    function initialsFrom(name){
      const parts = String(name).trim().split(/\s+/).filter(Boolean);
      const initials = parts.slice(0,2).map(x=>x[0].toUpperCase()).join('');
      return initials || 'U';
    }

    function setStatus(text){ $('status').textContent = text; }

    async function paintUser(){
      const { data:{ user } } = await supabase.auth.getUser();
      const area = $('userArea');
      if (!user) { area.style.visibility = 'hidden'; setStatus('Sin sesión'); return; }
      const { name, email, picture } = getUserDisplay(user);
      $('userName').textContent = name;
      $('userEmail').textContent = email || '—';
      const av = $('avatar');
      if (picture) { av.innerHTML = `<img alt="avatar" src="${picture}" style="width:100%;height:100%;object-fit:cover;"/>`; }
      else { av.textContent = initialsFrom(name); }
      area.style.visibility = 'visible';
      setStatus('Con sesión');
    }

    function bindMenu(){
      const area = $('userArea');
      const menu = $('menu');
      area.addEventListener('click', (e)=>{
        menu.classList.toggle('open');
      });
      window.addEventListener('click', (e)=>{
        if (!area.contains(e.target)) menu.classList.remove('open');
      });
    }

    async function copy(text){
      try { await navigator.clipboard.writeText(text); ok('Copiado al portapapeles'); } catch(e){ err('No se pudo copiar'); }
    }

    function bindActions(){
      $('btnLogout').onclick = async () => {
        await supabase.auth.signOut();
        ok('Sesión cerrada localmente');
        redirectToHub();
      };
      $('btnCopyAT').onclick = async () => {
        const { data:{ session } } = await supabase.auth.getSession();
        if (session?.access_token) copy(session.access_token);
      };
      $('btnCopyRT').onclick = async () => {
        const { data:{ session } } = await supabase.auth.getSession();
        if (session?.refresh_token) copy(session.refresh_token);
      };
    }

    async function ensureSessionFromHash(){
      const { access_token, refresh_token } = parseHashTokens();
      if (refresh_token) {
        ok('Tokens recibidos del Hub. Estableciendo sesión (con refresh_token)…');
        const { data, error } = await supabase.auth.setSession({ refresh_token });
        if (error) {
          err(`No se pudo establecer sesión: ${error.code || ''} ${error.message || error}`);
          // Si la sesión no existe (rotación o token inválido), pedir nuevos tokens al Hub
          if ((error.code && String(error.code).includes('session_not_found')) ||
              (String(error.message || '').includes('session_not_found'))) {
            markCooldown();
            clearHash();
            ok('Solicitando nuevos tokens al Hub…');
            redirectToHub();
          }
          return false;
        }
        clearHash();
        ok('Sesión establecida');
        return true;
      }
      err('No llegaron tokens en el hash (#). No se puede establecer sesión.');
      return false;
    }

    supabase.auth.onAuthStateChange((event) => {
      log(`Evento auth: ${event}`);
      if (event === 'SIGNED_IN') { paintUser(); }
      if (event === 'SIGNED_OUT') { setStatus('Sin sesión'); }
    });

    (async function bootstrap(){
      bindMenu();
      bindActions();
      ok('Iniciando demo…');
      const fromHash = await ensureSessionFromHash();
      if (!fromHash) {
        const { data:{ session } } = await supabase.auth.getSession();
        if (!session) {
          if (shouldCooldown()) {
            err('Previniendo bucle: cooldown activo. Revisa los logs o intenta de nuevo en unos segundos.');
            return;
          }
          ok('Sin sesión. Lanzando Hub…');
          return redirectToHub();
        }
      }
      await paintUser();
    })();
  })();
  </script>
</body>
</html>



